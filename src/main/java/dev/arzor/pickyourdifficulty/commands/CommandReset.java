// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                     ğŸ§© CommandReset.java                           â•‘
// â•‘  Handles /pyd reset <player> â€” clears difficulty + cooldown        â•‘
// â•‘  Requires permission: pickyourdifficulty.reset                     â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

package dev.arzor.pickyourdifficulty.commands;

import dev.arzor.pickyourdifficulty.managers.ConfigManager;
import dev.arzor.pickyourdifficulty.managers.MessagesManager;
import dev.arzor.pickyourdifficulty.storage.CooldownTracker;
import dev.arzor.pickyourdifficulty.storage.PlayerDifficultyStorage;

import dev.arzor.pickyourdifficulty.utils.PermissionUtil;

import net.kyori.adventure.text.minimessage.MiniMessage;

import org.bukkit.Bukkit;
import org.bukkit.OfflinePlayer;
import org.bukkit.command.Command;
import org.bukkit.command.CommandExecutor;
import org.bukkit.command.CommandSender;

import javax.annotation.Nonnull;
import java.util.UUID;

public class CommandReset implements CommandExecutor {

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ§° Utilities
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    /** MiniMessage formatter for colorized message output */
    private final MiniMessage mm = MiniMessage.miniMessage();

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // âš™ï¸ Command Execution
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    /**
     * Executes /pyd reset <player> â€” clears their difficulty and cooldown.
     */
    @Override
    public boolean onCommand(@Nonnull CommandSender sender, @Nonnull Command command, @Nonnull String label, @Nonnull String[] args) {

        // â•”â•â•â•â›” Permission Checkâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

        // ğŸ’¬ If permission enforcement is enabled and the sender lacks reset permission...
        if (ConfigManager.requireCommandPermissions() && !PermissionUtil.hasResetPermission(sender)) {
            // ğŸš« Inform the sender that they don't have access to this command
            sender.sendMessage(mm.deserialize(MessagesManager.get("error.no-permission-reset")));
            return true;
        }

        // â•”â•â•â•ğŸ“ Argument Checkâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

        // ğŸ’¬ Must specify a player name (e.g., /pyd reset ArZor)
        if (args.length < 2) {
            sender.sendMessage(mm.deserialize(MessagesManager.get("reset.usage")));
            return true;
        }

        // â•”â•â•â•ğŸ¯ Target Player Resolutionâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

        // ğŸ” Get offline player by name (works even if they're not online)
        OfflinePlayer target = Bukkit.getOfflinePlayer(args[1]);
        UUID targetUUID = target.getUniqueId();

        // â“ Check if this player has selected a difficulty before
        if (!PlayerDifficultyStorage.getInstance().hasSelected(targetUUID)) {
            sender.sendMessage(MessagesManager.format("admin.no-difficulty"));
            return true;
        }

        // â•”â•â•â•ğŸ§¹ Clear Difficulty + Cooldownâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

        // ğŸ’¬ If the player is online, and we can get the Player object, clear directly
        if (target.isOnline()) {
            if (target.getPlayer() != null) {
                PlayerDifficultyStorage.getInstance().clearDifficulty(target.getPlayer());
            } else {
                // ğŸ›¡ï¸ Fallback â€” shouldn't happen, but avoids a null pointer exception
                PlayerDifficultyStorage.getInstance().clearDifficulty(targetUUID);
            }
        } else {
            // ğŸ“¦ Offline â€” clear difficulty directly using UUID
            PlayerDifficultyStorage.getInstance().clearDifficulty(targetUUID);
        }

        // â±ï¸ Also clear their cooldown if one exists
        CooldownTracker.clearCooldown(targetUUID);

        // â•”â•â•â•âœ… Confirmation Messageâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

        // ğŸ’¬ Let the sender know it was successful
        sender.sendMessage(mm.deserialize(MessagesManager.get("reset.success")
                .replace("<player>", target.getName() != null ? target.getName() : targetUUID.toString())));

        return true;
    }
}